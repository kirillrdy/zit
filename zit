#!/usr/bin/env ruby

class Dataset

  attr :name, :used, :availible, :refer, :mountpoint

  def self.all
    list = `zfs list -H`
    list.split("\n").map{|x| Dataset.new(x)}
  end

  def self.current_dataset
    list = all.select do |dataset|
      Dir.pwd.index dataset.mountpoint
    end
    list.sort{|x,y| x.mountpoint.length <=> y.mountpoint.length }.last
  end

  def initialize string
    @name, @used, @availible, @refer, @mountpoint = string.split "\t"
  end

  def number_of_snapshots
    `ls -1 '#{@mountpoint}/.zfs/snapshot'`.split("\n").length
  end

  def snap
    system "zfs snapshot #{name}@#{number_of_snapshots + 1}"
  end

  def destroy_snapshot number
    system "zfs destroy #{name}@#{number}"
  end

  def list_snapshots
    system "zfs list -r -t snapshot #{name}"
  end

end

#TODO add list of availibe commands, like help
# Add diff

dataset = Dataset.current_dataset
case ARGV[0]
when 'snap','snapshot','commit'
  if ARGV[1] == 'list'
    dataset.list_snapshots
  else
    dataset.snap
  end
when 'i','identify'
  puts "Dataset: #{dataset.name}"
  puts "Number of snapshots: %d" % dataset.number_of_snapshots
when 'list'
  dataset.list_snapshots
when 'destroy','delete','kill'
  return unless ARGV[1]
  dataset.destroy_snapshot ARGV[1]
end
