#!/usr/bin/env ruby

class Dataset

  attr :name, :used, :availible, :refer, :mountpoint

  def self.all
    list = `zfs list -H`
    list.split("\n").map{|x| Dataset.new(x)}
  end

  def self.current_dataset
    list = all.select do |dataset|
      Dir.pwd.index dataset.mountpoint
    end
    list.sort{|x,y| x.mountpoint.length <=> y.mountpoint.length }.last
  end

  def initialize string
    @name, @used, @availible, @refer, @mountpoint = string.split "\t"
  end

  def number_of_snapshots
    `ls -1 '#{@mountpoint}/.zfs/snapshot'`.split("\n").length
  end

  def snap
    system "zfs snapshot #{name}@#{number_of_snapshots + 1}"
  end

end


dataset = Dataset.current_dataset
case ARGV[0]
when 'snap','snapshot'
  if ARGV[1] == 'list'
    system "zfs list -r -t snapshot #{dataset.name}"
  else
    dataset.snap
  end
when 'i','identify'
  puts "Dataset: #{dataset.name}"
  puts "Number of snapshots: %d" % dataset.number_of_snapshots
end
